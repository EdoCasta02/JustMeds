<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>JustMeds</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="../style.css">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="../index.html">
                    <img src="../images/Logo.png" alt="Logo" width="40" height="40">
                </a>
                <a class="navbar-brand" href="../index.html">Just Meds</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav me-auto">
                        <a class="nav-link active" aria-current="page" href="../index.html">Home</a>
                        <a class="nav-link" href="../about_us/about.html">Chi siamo</a>
                    </div>
                    <div class="navbar-nav">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#accountModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                                <path d="M13.468 12.37C12.758 11.226 11.48 10.5 10 10.5s-2.758.726-3.468 1.87A6.97 6.97 0 0 0 8 15a6.97 6.97 0 0 0 5.468-2.63zM8 9.5a4.5 4.5 0 1 1 0-9 4.5 4.5 0 0 1 0 9z"/>
                                <path fill-rule="evenodd" d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8z"/>
                                <path fill-rule="evenodd" d="M8 4a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <div class="container mt-4">
      <h2>Ordini disponibili</h2>
      <div id="ordersContainer" class="card-deck mt-3"></div>
  </div>
  
  <script>
    let isOrderAccepted = false;
    const cancelButton = document.createElement("button");
    
    document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch("/api/orders");
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                const orders = await response.json();
                const ordersContainer = document.getElementById("ordersContainer");

                const confirmedOrders = orders.filter(order => order.stato === 'confermato');

                if (confirmedOrders.length === 0) {
                    const noOrdersMessage = document.createElement("p");
                    noOrdersMessage.textContent = "Nessun ordine disponibile per il ritiro...";
                    ordersContainer.appendChild(noOrdersMessage);
                } else {
                    confirmedOrders.forEach((order) => {
                    const orderCard = document.createElement("div");
                    orderCard.classList.add("card", "mb-3");

                    const cardBody = document.createElement("div");
                    cardBody.classList.add("card-body");

                    const title = document.createElement("h5");
                    title.classList.add("card-title");
                    title.textContent = `Ordine #${order._id}`;
                    cardBody.appendChild(title);

                    const productList = document.createElement("ul");
                    productList.classList.add("list-group", "list-group-flush");

                    order.prodotti.forEach((product) => {
                        const productItem = document.createElement("li");
                        productItem.classList.add("list-group-item");
                        productItem.textContent = `${product._id.Farmaco} - Quantità: ${product.quantita} - Prezzo unitario: €${product.prezzo}`;
                        productList.appendChild(productItem);
                    });

                    cardBody.appendChild(productList);

                    const totalPrice = document.createElement("p");
                    totalPrice.classList.add("card-text", "mt-2");
                    totalPrice.innerHTML = `<strong>Prezzo Totale:</strong> €${order.prodotti.reduce((acc, item) => acc + (item.quantita * item.prezzo), 0)}`;
                    cardBody.appendChild(totalPrice);

                    const pickupAddress = document.createElement("p");
                    pickupAddress.classList.add("card-text");
                    pickupAddress.innerHTML = `<strong>Indirizzo di ritiro:</strong> ${order.indirizzoFarmacia.via}, ${order.indirizzoFarmacia.cap} ${order.indirizzoFarmacia.provincia}`;

                    const deliveryAddress = document.createElement("p");
                    deliveryAddress.classList.add("card-text");
                    deliveryAddress.innerHTML = `<strong>Indirizzo di consegna:</strong> ${order.indirizzoCliente.via}, ${order.indirizzoCliente.cap} ${order.indirizzoCliente.città}`;

                    cardBody.appendChild(pickupAddress);
                    cardBody.appendChild(deliveryAddress);

                    // Pulsante per accettare l'incarico
                    const acceptButton = document.createElement("button");
                    acceptButton.classList.add("btn", "btn-primary", "accept-button");
                    acceptButton.textContent = "Accetta Incarico";
                    acceptButton.dataset.orderId = order._id; // per salvare l'id dell'ordine
                    
                    // Pulsante per annullare l'accettazione
                    cancelButton.classList.add("btn", "btn-danger", "cancel-button", "d-none");
                    cancelButton.textContent = "Annulla Accettazione";
                    cancelButton.dataset.orderId = order._id;

                    if (isOrderAccepted || order.stato === 'attesa') {
                        acceptButton.disabled = true;
                        acceptButton.classList.remove("btn-primary");
                        acceptButton.classList.add("btn-secondary");
                        acceptButton.textContent = "Incarico accettato";
                        cancelButton.classList.remove("d-none"); // Add btn-secondary class
                    }
                    cardBody.appendChild(acceptButton);
                    cardBody.appendChild(cancelButton);

                    orderCard.appendChild(cardBody);
                    ordersContainer.appendChild(orderCard);
                        });
                    }
                } catch (error) {
                console.error("Errore nel caricare gli ordini:", error);
            }
    });
    // Funzione dell'evento click per accettare l'incarico
    document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("accept-button")) {
              const button = event.target;
              const orderId = button.dataset.orderId;
              try {
                  const response = await fetch(`/api/orders/${orderId}/accept`, { method: "POST" });
                  if (!response.ok) {
                      throw new Error("Errore durante l'accettazione dell'incarico");
                  }
                  const data = await response.json();
                isOrderAccepted = true;
                button.classList.add("d-none");
                cancelButton.classList.remove("d-none"); 
                button.disabled = true;
                button.classList.remove("btn-primary");
                button.classList.add("btn-secondary");
                button.textContent = "Incarico accettato";
                alert("Incarico accettato");

                window.location.href = `delivery_management.html?orderId=${orderId}`;
              } catch (error) {
                  console.error("Errore durante l'accettazione dell'incarico:", error);
                  alert("Errore durante l'accettazione dell'incarico");
              }
          }
      });
    // Funzione dell'evento click per annullare l'accettazione
    document.addEventListener("click", async (event) => {
        if (event.target.classList.contains("cancel-button")) { 
            const button = event.target;
            const orderId = button.dataset.orderId;
            try {
                const response = await fetch(`/api/orders/${orderId}/cancel`, { method: "POST" });
                if (!response.ok) {
                    throw new Error("Errore durante l'annullamento dell'accettazione dell'incarico");
                }
            const data = await response.json();
            const acceptButton = button.previousElementSibling;
            acceptButton.disabled = false;
            acceptButton.classList.add("btn-primary");
            acceptButton.classList.remove("btn-secondary");
            button.classList.add("d-none");
            acceptButton.classList.remove("d-none");
            alert("Accettazione dell'incarico annullata");
        } catch (error) {
            console.error("Errore durante l'annullamento dell'accettazione dell'incarico:", error);
            alert("Errore durante l'annullamento dell'accettazione dell'incarico");
            }
        }
    });
  </script>
  



    <!-- POPUP PER LA GESTIONE DELL'ACCOUNT -->
    <div class="modal fade" id="accountModal" tabindex="-1" aria-labelledby="accountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="accountModalLabel">Il tuo Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Ordini accettati:</strong> 5</p>
                    <p><strong>Soldo guadagnati:</strong> €50</p>
                    <div class="d-grid">
                    <button class="btn btn-secondary mb-2" onclick="window.location.href='delivery_management.html'">Visualizza Ordini Accettati</button>
                    <button class="btn btn-danger" onclick="window.location.href='/logout'">Logout</button>
                  </div>
                </div>
            </div>
        </div>
    </div>

    <footer style="background-color: gray;">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <p>&copy; 2024 Just Meds. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
</body>
</html>
