<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JustMeds</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a href="../index.html">
                    <img src="../images/Logo.png" alt="Logo" class="navbar-brand img-fluid" style="width: 40px">
                </a>
                <a class="navbar-brand" href="../index.html">JustMeds</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav">
                        <a class="nav-link" href="../about_us/about.html">Chi siamo</a>
                        <a class="nav-link" href="../order/order.html" id="orderLink">Lista Farmaci</a>
                        <!-- Logout link will be dynamically inserted here if user is logged in -->
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- STORICO -->
    <div class="container mt-4">
        <h2>Ordine attuale</h2>
        <div class="card-deck mt-3" id="waitingOrders"></div>
    </div>

    <div class="container mt-4 mb-4">
        <div id="map" style="height: 500px;"></div>
    </div>

    <!-- RIEPILOGO GUADAGNI/PERDITE TOTALI -->
    <div class="container mt-4 mb-5">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Riepilogo Guadagni</h5>
                <p class="card-text"><strong>Soldi Guadagnati:</strong> €5</p>
                <!-- Aggiungi qui il calcolo del totale dei guadagni (o perdite) -->
            </div>
        </div>
    </div>

    <script>
        let isOrderAccepted = false;
        const cancelButton = document.createElement("button");

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                console.log("Fetching orders...");
                const response = await fetch("/api/orders");
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                const orders = await response.json();
                console.log("Orders fetched:", orders);
                const waitingOrdersContainer = document.getElementById("waitingOrders");

                const waitingOrders = orders.filter(order => order.stato === 'attesa' || order.stato === 'confermato');
                console.log("Filtered waiting orders:", waitingOrders);

                if (waitingOrders.length === 0) {
                    const noOrdersMessage = document.createElement("p");
                    noOrdersMessage.textContent = "Nessun ordine in attesa di conferma...";
                    waitingOrdersContainer.appendChild(noOrdersMessage);
                } else {
                    waitingOrders.forEach((order, orderIndex) => {
                        const orderCard = document.createElement("div");
                        orderCard.classList.add("card", "mb-3");

                        const cardBody = document.createElement("div");
                        cardBody.classList.add("card-body");

                        const title = document.createElement("h5");
                        title.classList.add("card-title");
                        title.textContent = `Ordine #${order._id}`;
                        cardBody.appendChild(title);

                        const productList = document.createElement("ul");
                        productList.classList.add("list-group", "list-group-flush");

                        let productCounter = 1; // contatore prodotto per ogni ordine

                        order.prodotti.forEach((product) => {
                            const productItem = document.createElement("li");
                            productItem.classList.add("list-group-item");
                            productItem.textContent = `Farmaco ${productCounter} - Quantità: ${product.quantita} - Prezzo unitario: €${product.prezzo}`;
                            productList.appendChild(productItem);
                            productCounter++;
                        });

                        cardBody.appendChild(productList);

                        const totalPrice = document.createElement("p");
                        totalPrice.classList.add("card-text", "mt-2");
                        totalPrice.innerHTML = `<strong>Prezzo Totale:</strong> €${order.prodotti.reduce((acc, item) => acc + (item.quantita * item.prezzo), 0)}`;
                        cardBody.appendChild(totalPrice);

                        const pickupAddress = document.createElement("p");
                        pickupAddress.classList.add("card-text");
                        pickupAddress.innerHTML = `<strong>Indirizzo di ritiro:</strong> ${order.indirizzoFarmacia.via}, ${order.indirizzoFarmacia.cap} ${order.indirizzoFarmacia.provincia}`;

                        const deliveryAddress = document.createElement("p");
                        deliveryAddress.classList.add("card-text");
                        deliveryAddress.innerHTML = `<strong>Indirizzo di consegna:</strong> ${order.indirizzoCliente.via}, ${order.indirizzoCliente.cap} ${order.indirizzoCliente.città}`;

                        const showCodeButton = document.createElement("button");
                        showCodeButton.classList.add("btn", "btn-primary", "mt-2");
                        showCodeButton.textContent = "Mostra codice segreto";
                        showCodeButton.onclick = () => showSecretCode(order._id, showCodeButton);
                        
                        const acceptButton = document.createElement("button");
                        acceptButton.classList.add("btn", "btn-success", "mt-2", "me-2");
                        acceptButton.textContent = "Accetta incarico";
                        acceptButton.dataset.orderId = order._id;
                        acceptButton.classList.add("accept-button");
                        
                        const secretCode = document.createElement("p");
                        secretCode.classList.add("card-text", `secret-code-${order._id}`);
                        secretCode.style.display = "none";
                        secretCode.innerHTML = `<strong>Secret Code:</strong> ${order.secretcode}`;

                        cardBody.appendChild(pickupAddress);
                        cardBody.appendChild(deliveryAddress);
                        cardBody.appendChild(showCodeButton); 
                        cardBody.appendChild(acceptButton);
                        cardBody.appendChild(secretCode);

                        orderCard.appendChild(cardBody);
                        waitingOrdersContainer.appendChild(orderCard);
                    });
                }
            } catch (error) {
                console.error("Errore nel caricare gli ordini in attesa:", error);
            }
        });

        // ACCETTAZIONE ORDINE
        document.addEventListener("click", async (event) => {
          if (event.target.classList.contains("accept-button")) {
              const button = event.target;
              const orderId = button.dataset.orderId;
              try {
                  const response = await fetch(`/api/orders/${orderId}/accept`, { method: "POST" });
                  if (!response.ok) {
                      throw new Error("Errore durante l'accettazione dell'incarico");
                  }
                const data = await response.json();
                isOrderAccepted = true;
                button.classList.add("d-none");
                cancelButton.classList.remove("d-none"); 
                button.disabled = true;
                button.classList.remove("btn-primary");
                button.classList.add("btn-secondary");
                button.textContent = "Incarico accettato";
                alert("Incarico accettato");

    
              } catch (error) {
                  console.error("Errore durante l'accettazione dell'incarico:", error);
                  alert("Errore durante l'accettazione dell'incarico");
              }
          }
      });

      // ANNULLAMENTO ORDINE
      document.addEventListener("click", async (event) => {
        if (event.target.classList.contains("cancel-button")) { 
            const button = event.target;
            const orderId = button.dataset.orderId;
            try {
                const response = await fetch(`/api/orders/${orderId}/cancel`, { method: "POST" });
                if (!response.ok) {
                    throw new Error("Errore durante l'annullamento dell'accettazione dell'incarico");
                }
            const data = await response.json();
            const acceptButton = button.previousElementSibling;
            acceptButton.disabled = false;
            acceptButton.classList.add("btn-primary");
            acceptButton.classList.remove("btn-secondary");
            button.classList.add("d-none");
            acceptButton.classList.remove("d-none");
            alert("Accettazione dell'incarico annullata");
            isOrderAccepted = false;
            acceptButton.textContent = "Accetta Incarico";
        } catch (error) {
            console.error("Errore durante l'annullamento dell'accettazione dell'incarico:", error);
            alert("Errore durante l'annullamento dell'accettazione dell'incarico");
            }
        }
    });

        function showSecretCode(orderId, button) {
            const secretCodeElement = document.querySelector(`.secret-code-${orderId}`);
            if (secretCodeElement) {
                secretCodeElement.style.display = "block";  // Mostra il codice segreto
                button.style.display = "none";  // Nascondi il bottone
                setTimeout(() => {
                    secretCodeElement.style.display = "none";  // Nascondi il codice segreto dopo 5 minuti
                }, 300000);  // 300000 millisecondi = 5 minuti
            }
        }

        function createOrderCard(order, orderIndex) {
            const orderCard = document.createElement("div");
            orderCard.classList.add("card", "mb-3");

            const cardBody = document.createElement("div");
            cardBody.classList.add("card-body");

            const title = document.createElement("h5");
            title.classList.add("card-title");
            title.textContent = `Ordine #${order._id}`;
            cardBody.appendChild(title);

            const productList = document.createElement("ul");
            productList.classList.add("list-group", "list-group-flush");

            let productCounter = 1;

            order.prodotti.forEach((product) => {
                const productItem = document.createElement("li");
                productItem.classList.add("list-group-item");
                productItem.textContent = `Farmaco ${productCounter} - Quantità: ${product.quantita} - Prezzo unitario: €${product.prezzo}`;
                productList.appendChild(productItem);
                productCounter++;
            });

            cardBody.appendChild(productList);

            const totalPrice = document.createElement("p");
            totalPrice.classList.add("card-text", "mt-2");
            totalPrice.innerHTML = `<strong>Prezzo Totale:</strong> €${order.prodotti.reduce((acc, item) => acc + (item.quantita * item.prezzo), 0)}`;
            cardBody.appendChild(totalPrice);

            const pickupAddress = document.createElement("p");
            pickupAddress.classList.add("card-text");
            pickupAddress.innerHTML = `<strong>Indirizzo di ritiro:</strong> ${order.indirizzoFarmacia.via}, ${order.indirizzoFarmacia.cap} ${order.indirizzoFarmacia.provincia}`;

            const deliveryAddress = document.createElement("p");
            deliveryAddress.classList.add("card-text");
            deliveryAddress.innerHTML = `<strong>Indirizzo di consegna:</strong> ${order.indirizzoCliente.via}, ${order.indirizzoCliente.cap} ${order.indirizzoCliente.città}`;

            cardBody.appendChild(pickupAddress);
            cardBody.appendChild(deliveryAddress);

            orderCard.appendChild(cardBody);
            return orderCard;
        }

        
    </script>

    <!-- Script per la mappa -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            if (document.getElementById('map')) {
                var map = L.map('map').setView([46.06723541852145, 11.120870099071267], 15); // Imposta la vista iniziale della mappa

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // MARKER
                var marker = L.marker([46.06723541852145, 11.120870099071267]).addTo(map)
            }
        });
    </script>


    <footer class="bg-dark text-white text-center p-0 mt-4">
        <div class="container">
            <p>&copy; 2024 JustMeds. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
</body>
</html>
